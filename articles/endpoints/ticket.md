# Эндпоинт с API талонов

## Выдача талона

**Адрес**

/ticket

**Тип эндпоинта**

GET

**Входные параметры**

|Параметр|Тип|Обязательность|Комментарий|
|--|--|--|--|
|TargetCode|int|yes|Код цели\отдела|

**Алгоритм**

1. Проверяется корректность указания TargetCode. Если TargetCode указан некорректно - вернуть в ответ код 400.
2. Определяется префикс указанного отдела\цели. Префикс получается по следующей логике - по TargetCode определяется запись в таблице target, оттуда дёргается префикс.
3. Очередь блокируется для добавления новых записей другими процессами. Из очереди считывается последний номер для указанного отдела\цели.
4. Генерируется следующий номер, к которому конкатенируется префикс указанного отдела\цели (например П41).
5. Новый номер добавляется в очередь. Если добавление прошло успешно, блокировка с очереди снимается. Если добавление прошло с ошибками - в ответ вернуть код 500.
6. Данные по добавленному номеру сохраняются в таблицу ticket (с целью избежания утраты данных по очереди при отключении электричества).
6. В ответ формируется json с номером талона.

**Выходные параметры**

|Параметр|Тип|Обязательность|Комментарий|
|--|--|--|--|
|TicketNumber|string|yes|Номер талона|


## Перенаправление талона на другую цель

**Адрес**

/ticket/redirect

**Тип эндпоинта**

POST

**Входные параметры**

|Параметр|Тип|Обязательность|Комментарий|
|--|--|--|--|
|TargetCode|int|yes|Код цели\отдела|
|TicketNumber|string|yes|Номер талона|

**Алгоритм**

1. Очередь блокируется для добавления новых записей другими процессами. 
2. В начало очереди добавляется талон, ранее исключённый из этой очереди (талон имеет приоритет в рамках конкретной цели перед остальными талонами, так как посетитель получил его раньше остальных; при этом в очередь могут быть возвращены несколько талонов, потребуется отмечать талоны меткой возвращён\необрабатывался\обрабатывается, и если в очереди уже есть возвращённый талон, то свежевозвращаемый талон добавлять не первым и не вторым, а третьим в очередь, соблюдая шаг "через одного"(такая же логика работает для всех последующих талонов)).
3. Блокировка с очереди снимается.

**Выходные параметры**

*Отсутствуют*

## Список талонов

**Адрес**

/list

**Тип эндпоинта**

GET

**Входные параметры**

|Параметр|Тип|Обязательность|Комментарий|
|--|--|--|--|
|EmployeeCode|int|yes|Код сотрудника|

**Алгоритм**

Возвращает список всех талонов, обработанных сотрудником за последние N минут (N лежит в таблице config).

**Выходные параметры**

Возвращается массив.

|Параметр|Тип|Обязательность|Комментарий|
|--|--|--|--|
|TicketNumber|string|yes|Номер|